# Node Bridge - Инструкция по сборке EXE

## ⚡ ВАЖНО: ВСТРАИВАНИЕ NODE.JS

**EXE может быть собран БЕЗ необходимости устанавливать Node.js на целевой машине!**

Подробная инструкция: **[EMBEDDING_NODEJS.md](EMBEDDING_NODEJS.md)**

### Быстрый старт (со встроенным Node.js):

1. Скачайте портативный Node.js: https://nodejs.org/en/download (Windows Binary .zip)
2. Распакуйте в папку `nodejs_portable/`
3. Положите ваш `server.js` в корень проекта
4. Запустите:
```bash
pyinstaller --clean NodeBridge_portable.spec
```

✅ Готовый EXE будет полностью автономным!

---

## Структура проекта

```
node_bridge_project/
├── src/                    # Исходный код
│   ├── main.py            # Главный модуль
│   ├── gui_module.py      # GUI модуль
│   └── mqtt_module.py     # MQTT модуль
├── assets/                # Ресурсы (иконки и т.д.)
├── build/                 # Временные файлы сборки
├── dist/                  # Готовый EXE (появится после сборки)
├── requirements.txt       # Python зависимости
├── NodeBridge.spec       # Конфигурация PyInstaller
├── build.bat             # Скрипт автоматической сборки
└── README.md             # Этот файл
```

## Требования

1. **Python 3.8+** установлен и добавлен в PATH
2. **Node.js** установлен (для работы server.js)
3. **Google Chrome** установлен по стандартному пути

## Быстрая сборка (рекомендуется)

### Вариант 1: Автоматическая сборка

1. Откройте командную строку в папке проекта
2. Запустите:
   ```bash
   build.bat
   ```

Скрипт автоматически:
- Создаст виртуальное окружение
- Установит все зависимости
- Соберет EXE файл

### Вариант 2: Ручная сборка

1. Создайте виртуальное окружение:
   ```bash
   python -m venv venv
   ```

2. Активируйте его:
   ```bash
   venv\Scripts\activate
   ```

3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

4. Соберите EXE:
   ```bash
   pyinstaller --clean NodeBridge.spec
   ```

## После сборки

### С встроенным Node.js (рекомендуется):

1. Готовый EXE будет в папке `dist\NodeBridge.exe`
2. **Файл полностью автономный** - можно переносить на любую Windows машину
3. Node.js и server.js уже встроены в EXE
4. На целевой машине НЕ требуется устанавливать Node.js ✅

### Без встроенного Node.js:

1. Готовый EXE будет в папке `dist\NodeBridge.exe`
2. **ВАЖНО**: Положите файл `server.js` рядом с `NodeBridge.exe`:
   ```
   dist/
   ├── NodeBridge.exe
   └── server.js        ← Обязательно!
   ```
3. На целевой машине **потребуется** установить Node.js
4. Файл `history.json` будет автоматически создан рядом с EXE при первом запуске

## Дополнительные настройки

### Добавление иконки

1. Положите файл `icon.ico` в папку `assets/`
2. Откройте `NodeBridge.spec`
3. Найдите строку `icon=None`
4. Замените на `icon='assets\\icon.ico'`
5. Пересоберите проект

### Режим с консолью (для отладки)

В файле `NodeBridge.spec` измените:
```python
console=False  # на console=True
```

Это откроет консольное окно вместе с GUI, где будут видны все ошибки.

### Изменение размера EXE

Текущая сборка использует режим `--onefile` (один файл). Если нужен меньший размер:

1. В `NodeBridge.spec` закомментируйте строки `a.binaries, a.zipfiles, a.datas`
2. Добавьте вместо них отдельный блок `COLLECT`

## Распространение

### С встроенным Node.js (автономный режим):

**Минимальный набор:**
- `NodeBridge.exe` (всё встроено внутри)

**Требования на целевой машине:**
- Windows 7/10/11
- Google Chrome установлен

### Без встроенного Node.js:

**Минимальный набор:**
- `NodeBridge.exe`
- `server.js`

**Требования на целевой машине:**
- Windows 7/10/11
- Node.js установлен
- Google Chrome установлен

## Устранение проблем

### Антивирус блокирует EXE

PyInstaller иногда вызывает ложные срабатывания. Решения:
1. Добавьте папку `dist` в исключения антивируса
2. Используйте параметр `--exclude-module` для неиспользуемых библиотек

### Ошибка "No module named ..."

1. Убедитесь, что модуль добавлен в `hiddenimports` в `.spec` файле
2. Пересоберите с флагом `--clean`

### EXE не запускается

1. Соберите с `console=True` для просмотра ошибок
2. Проверьте наличие `server.js` рядом с EXE
3. Проверьте путь к Chrome в `main.py` (константа `CHROME_PATH`)

## Изменение настроек

Основные настройки в `src/main.py`:

```python
CHROME_PATH = r"C:\Program Files\Google\Chrome\Application\chrome.exe"
WIN_X, WIN_Y, WIN_W, WIN_H = 1250, 50, 420, 450  # Позиция и размер окна
DEFAULT_MQTT_PORT = 1883
```

После изменений пересоберите проект.

## Логирование

При работе в режиме EXE:
- `history.json` сохраняется рядом с EXE
- Логи отображаются в консоли приложения
- Для debug режима используйте `console=True`

## Версионирование

Чтобы добавить информацию о версии в EXE:

1. Создайте файл `version.txt` с данными версии
2. Используйте параметр `--version-file` в PyInstaller
3. Или добавьте `version=...` в блок `EXE()` в `.spec` файле
